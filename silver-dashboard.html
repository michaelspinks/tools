
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver Market Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none; }
            body { background: white !important; }
        }
        
        .blink-success {
            animation: blink-green 0.5s ease-in-out;
        }
        
        @keyframes blink-green {
            0%, 100% { background-color: rgb(30 41 59); }
            50% { background-color: rgb(34 197 94); }
        }
        
        .pulse-price {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .collapsible-content.open {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }
        
        .rotate-180 {
            transform: rotate(180deg);
        }
        
        .transition-transform {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-800 text-slate-50 min-h-screen p-4 md:p-6">
    
    <!-- Header -->
    <header class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold text-indigo-400">Silver Market Monitor</h1>
            <p class="text-slate-400 mt-1">Real-time vault inventories & price tracking across global exchanges</p>
        </div>
        <div class="flex gap-2 no-print">
            <button onclick="clearAllData()" 
                    class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-50 rounded transition">
                Clear Data
            </button>
            <button onclick="copyReport()" 
                    id="copyBtn"
                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded transition">
                Copy Report
            </button>
            <button onclick="downloadReport()" 
                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded transition">
                Download
            </button>
        </div>
    </header>

    <!-- Toolbar -->
    <div class="bg-slate-700 rounded-lg p-4 mb-6">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-xs uppercase text-slate-300 mb-1">API Key</label>
                <input type="password" 
                       id="apiKey" 
                       placeholder="Enter MetalpriceAPI key"
                       class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-slate-50 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       oninput="saveConfig()">
            </div>
            
            <div>
                <label class="block text-xs uppercase text-slate-300 mb-1">Auto-Refresh</label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" 
                           id="autoRefresh" 
                           class="mr-2"
                           onchange="toggleAutoRefresh()">
                    <span class="text-sm text-slate-300">Every 5 min</span>
                </label>
            </div>
            
            <div class="ml-auto">
                <div class="text-xs uppercase text-slate-400">Last Updated</div>
                <div id="lastUpdate" class="text-sm font-mono text-indigo-400">Never</div>
            </div>
        </div>
    </div>

    <!-- AT A GLANCE SECTION -->
    <div class="mb-6">
        <div class="bg-slate-700 rounded-lg overflow-hidden">
            <button onclick="toggleSection('glance')" 
                    class="w-full bg-slate-600 px-4 py-3 flex justify-between items-center hover:bg-slate-550 transition">
                <h2 class="font-semibold text-lg text-slate-50">üìä At a Glance</h2>
                <svg id="glance-arrow" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="glance-content" class="collapsible-content open">
                <div class="p-4">
                    
                    <!-- Global Summary Bar -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-slate-800 rounded-lg p-4 text-center">
                            <div class="text-xs text-slate-400 uppercase mb-1">Global Visible Stock</div>
                            <div id="quickGlobalTotal" class="text-2xl font-bold text-indigo-400">--</div>
                            <div class="text-xs text-slate-500 mt-1">million oz</div>
                        </div>
                        <div class="bg-slate-800 rounded-lg p-4 text-center">
                            <div class="text-xs text-slate-400 uppercase mb-1">London (LBMA)</div>
                            <div id="quickLondon" class="text-2xl font-bold text-slate-50">¬£--</div>
                            <div class="text-xs text-slate-500 mt-1">per oz</div>
                        </div>
                        <div class="bg-slate-800 rounded-lg p-4 text-center">
                            <div class="text-xs text-slate-400 uppercase mb-1">New York (COMEX)</div>
                            <div id="quickComex" class="text-2xl font-bold text-slate-50">$--</div>
                            <div class="text-xs text-slate-500 mt-1">per oz</div>
                        </div>
                        <div class="bg-slate-800 rounded-lg p-4 text-center">
                            <div class="text-xs text-slate-400 uppercase mb-1">Shanghai Premium</div>
                            <div id="quickPremium" class="text-2xl font-bold">--</div>
                            <div class="text-xs text-slate-500 mt-1">vs London</div>
                        </div>
                    </div>

                    <!-- Comparison Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="text-xs uppercase text-slate-400 bg-slate-800">
                                <tr>
                                    <th class="text-left px-4 py-3">Exchange</th>
                                    <th class="text-left px-4 py-3">Type</th>
                                    <th class="text-right px-4 py-3">Total Stock</th>
                                    <th class="text-right px-4 py-3">Available for Delivery</th>
                                    <th class="text-right px-4 py-3">% of Global</th>
                                    <th class="text-center px-4 py-3">Status</th>
                                </tr>
                            </thead>
                            <tbody class="text-slate-300">
                                <tr class="border-b border-slate-700">
                                    <td class="px-4 py-3 font-semibold">üá∫üá∏ COMEX</td>
                                    <td class="px-4 py-3">Futures</td>
                                    <td class="text-right px-4 py-3 font-mono" id="tableComexTotal">--</td>
                                    <td class="text-right px-4 py-3 font-mono text-green-400" id="tableComexReg">--</td>
                                    <td class="text-right px-4 py-3 font-mono" id="tableComexPct">--%</td>
                                    <td class="text-center px-4 py-3"><span id="tableComexStatus" class="px-2 py-1 rounded text-xs bg-slate-700">--</span></td>
                                </tr>
                                <tr class="border-b border-slate-700">
                                    <td class="px-4 py-3 font-semibold">üá¨üáß LBMA</td>
                                    <td class="px-4 py-3">OTC Spot</td>
                                    <td class="text-right px-4 py-3 font-mono" id="tableLbmaTotal">--</td>
                                    <td class="text-right px-4 py-3 font-mono text-slate-500">N/A</td>
                                    <td class="text-right px-4 py-3 font-mono" id="tableLbmaPct">--%</td>
                                    <td class="text-center px-4 py-3"><span id="tableLbmaStatus" class="px-2 py-1 rounded text-xs bg-slate-700">--</span></td>
                                </tr>
                                <tr class="border-b border-slate-700">
                                    <td class="px-4 py-3 font-semibold">üá®üá≥ SHFE</td>
                                    <td class="px-4 py-3">Futures</td>
                                    <td class="text-right px-4 py-3 font-mono" id="tableShfeTotal">--</td>
                                    <td class="text-right px-4 py-3 font-mono text-green-400" id="tableShfeDel">All*</td>
                                    <td class="text-right px-4 py-3 font-mono" id="tableShfePct">--%</td>
                                    <td class="text-center px-4 py-3"><span id="tableShfeStatus" class="px-2 py-1 rounded text-xs bg-slate-700">--</span></td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-slate-800 font-semibold">
                                <tr>
                                    <td class="px-4 py-3" colspan="2">Total Visible</td>
                                    <td class="text-right px-4 py-3 font-mono text-indigo-400" id="tableGlobalTotal">--</td>
                                    <td class="px-4 py-3"></td>
                                    <td class="text-right px-4 py-3">100%</td>
                                    <td class="px-4 py-3"></td>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="mt-2 text-xs text-slate-400 px-4">
                            * SHFE uses warehouse warrant system - all warranted stock is deliverable
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- PAPER VS PHYSICAL SECTION -->
    <div class="mb-6">
        <div class="bg-slate-700 rounded-lg overflow-hidden border-2 border-amber-600">
            <button onclick="toggleSection('paper')" 
                    class="w-full bg-slate-600 px-4 py-3 flex justify-between items-center hover:bg-slate-550 transition">
                <div class="flex items-center gap-3">
                    <h2 class="font-semibold text-lg text-slate-50">‚ö†Ô∏è Paper vs Physical Silver</h2>
                    <span class="text-xs px-2 py-1 bg-amber-600 text-white rounded">Risk Indicator</span>
                </div>
                <svg id="paper-arrow" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="paper-content" class="collapsible-content open">
                <div class="p-4">
                    
                    <!-- Warning Banner -->
                    <div class="bg-amber-900 bg-opacity-30 border border-amber-600 rounded-lg p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">‚ö†Ô∏è</span>
                            <div>
                                <div class="font-semibold text-amber-400 mb-1">Fractional Reserve System Alert</div>
                                <div class="text-sm text-slate-300">
                                    Silver operates on a fractional reserve system where paper claims vastly exceed physical metal available for delivery. 
                                    Monitor these ratios for market stress indicators.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Metrics Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-slate-800 rounded-lg p-4 text-center">
                            <div class="text-xs text-slate-400 uppercase mb-2">COMEX Paper:Physical</div>
                            <div id="comexLeverageRatio" class="text-3xl font-bold text-amber-400">--</div>
                            <div class="text-xs text-slate-500 mt-2">oz of claims per oz deliverable</div>
                        </div>
                        <div class="bg-slate-800 rounded-lg p-4 text-center">
                            <div class="text-xs text-slate-400 uppercase mb-2">Global Paper:Physical</div>
                            <div id="globalLeverageRatio" class="text-3xl font-bold text-red-400">~300:1</div>
                            <div class="text-xs text-slate-500 mt-2">estimated ratio (all derivatives)</div>
                        </div>
                        <div class="bg-slate-800 rounded-lg p-4 text-center">
                            <div class="text-xs text-slate-400 uppercase mb-2">Physical Delivery Rate</div>
                            <div class="text-3xl font-bold text-green-400">1-3%</div>
                            <div class="text-xs text-slate-500 mt-2">of COMEX contracts</div>
                        </div>
                    </div>

                    <!-- Shanghai Premium Alert Card -->
                    <div id="shanghaiPremiumCard" class="mb-6 bg-slate-800 rounded-lg p-4 border-2 border-slate-700">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-slate-50 flex items-center gap-2">
                                <span>üá®üá≥</span>
                                <span>Shanghai Premium Alert</span>
                            </h3>
                            <span id="premiumAlertBadge" class="text-xs px-3 py-1 rounded font-semibold bg-slate-600 text-slate-300">
                                Monitoring
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Current Premium -->
                            <div class="bg-slate-900 rounded-lg p-4">
                                <div class="text-center">
                                    <div class="text-xs text-slate-400 uppercase mb-2">Current Premium</div>
                                    <div id="livePremiumValue" class="text-5xl font-bold mb-2" style="color: #10b981;">--</div>
                                    <div class="text-xs text-slate-500 mb-3">Shanghai vs London Spot</div>
                                    
                                    <div class="space-y-1 text-left text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">Shanghai (USD):</span>
                                            <span id="premiumShanghaiPrice" class="font-mono text-slate-300">--</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">London (USD):</span>
                                            <span id="premiumLondonPrice" class="font-mono text-slate-300">--</span>
                                        </div>
                                        <div class="flex justify-between pt-1 border-t border-slate-700">
                                            <span class="text-slate-400">Difference:</span>
                                            <span id="premiumDifference" class="font-mono text-slate-300">--</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Threshold Scale -->
                            <div class="bg-slate-900 rounded-lg p-4">
                                <div class="text-xs text-slate-400 uppercase mb-3">Risk Level</div>
                                
                                <!-- Visual Bar -->
                                <div class="relative h-8 bg-slate-800 rounded-lg mb-4 overflow-hidden">
                                    <div id="premiumProgressBar" class="h-full transition-all duration-500 ease-out" style="width: 0%; background: #10b981;"></div>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span id="premiumBarText" class="text-xs font-semibold text-white drop-shadow-lg">--</span>
                                    </div>
                                </div>
                                
                                <!-- Threshold Legend -->
                                <div class="space-y-2">
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded" style="background: #10b981;"></div>
                                        <span class="text-xs text-slate-400">0-3%: Normal</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded" style="background: #eab308;"></div>
                                        <span class="text-xs text-slate-400">3-5%: Elevated</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded" style="background: #f97316;"></div>
                                        <span class="text-xs text-slate-400">5-8%: High Alert</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded" style="background: #ef4444;"></div>
                                        <span class="text-xs text-slate-400">8%+: Critical</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Message -->
                        <div id="premiumStatusMessage" class="mt-4 p-3 bg-slate-900 rounded-lg">
                            <div class="text-sm text-slate-300">
                                <span class="font-semibold">Status:</span> <span id="premiumStatusText">Waiting for price data...</span>
                            </div>
                        </div>
                        
                        <!-- Historical Note -->
                        <div class="mt-4 p-3 bg-blue-900 bg-opacity-20 border border-blue-600 rounded text-xs text-slate-300">
                            <strong>Recent History:</strong> Shanghai premium hit 12-13% in Dec 2025 during extreme market stress. Any premium above 8% signals physical scarcity and potential paper market failure.
                        </div>
                    </div>

                    <!-- Detailed Breakdown -->
                    <div class="space-y-4">
                        
                        <!-- COMEX Paper Silver -->
                        <div class="bg-slate-800 rounded-lg p-4">
                            <h3 class="font-semibold text-slate-50 mb-3">üóΩ COMEX Paper Silver</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-slate-400">Open Interest (Contracts)</span>
                                    <span id="comexOpenInterest" class="font-mono text-slate-50">~100,000</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-slate-400">Open Interest (Ounces)</span>
                                    <span id="comexOpenInterestOz" class="font-mono text-slate-50">500M oz</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-slate-700">
                                    <span class="text-sm text-slate-400">Registered (Deliverable)</span>
                                    <span id="paperComexRegistered" class="font-mono text-green-400">--</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-slate-400 font-semibold">Leverage Ratio</span>
                                    <span id="comexRatioDetail" class="font-mono font-bold text-amber-400">--</span>
                                </div>
                            </div>
                            <div class="mt-4 p-3 bg-slate-900 rounded">
                                <div class="text-xs text-slate-400 mb-2">Risk Assessment:</div>
                                <div id="comexRiskBar" class="w-full bg-slate-700 rounded-full h-3 mb-2">
                                    <div id="comexRiskFill" class="bg-amber-500 h-3 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                                <div id="comexRiskText" class="text-xs text-slate-300">--</div>
                            </div>
                        </div>

                        <!-- Other Paper Silver -->
                        <div class="bg-slate-800 rounded-lg p-4">
                            <h3 class="font-semibold text-slate-50 mb-3">üìÑ Other Paper Silver</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-slate-400">Silver ETFs (SLV, PSLV, etc.)</span>
                                    <span class="font-mono text-slate-50">~600-700M oz</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-slate-400">LBMA Unallocated (estimate)</span>
                                    <span class="font-mono text-slate-50">Unknown (billions)</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-slate-400">OTC Derivatives</span>
                                    <span class="font-mono text-slate-50">Not disclosed</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-slate-700">
                                    <span class="text-sm text-slate-400 font-semibold">Total Paper Estimate</span>
                                    <span class="font-mono font-bold text-red-400">Billions of oz</span>
                                </div>
                            </div>
                        </div>

                        <!-- Market Stress Indicators -->
                        <div class="bg-slate-800 rounded-lg p-4">
                            <h3 class="font-semibold text-slate-50 mb-3">üå°Ô∏è Market Stress Indicators</h3>
                            <div class="space-y-3">
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm text-slate-400">Silver Lease Rates</span>
                                        <span class="text-xs text-slate-500">Normal: 0.1-2% | Critical: >10%</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="leaseRateInput" 
                                               class="px-2 py-1 bg-slate-900 border border-slate-600 rounded text-slate-50 text-sm w-24"
                                               placeholder="Enter %"
                                               step="0.1"
                                               oninput="updateStressIndicators()">
                                        <span class="text-xs text-slate-400">%</span>
                                        <span id="leaseRateStatus" class="text-xs px-2 py-1 rounded bg-slate-700">--</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm text-slate-400">Shanghai Premium</span>
                                        <span class="text-xs text-slate-500">Normal: 0-3% | Critical: >8%</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div id="shanghaiPremiumDisplay" class="text-sm font-mono text-slate-50">--</div>
                                        <span id="shanghaiPremiumStatus" class="text-xs px-2 py-1 rounded bg-slate-700">--</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm text-slate-400">LBMA Bid-Ask Spread</span>
                                        <span class="text-xs text-slate-500">Normal: $0.03 | Critical: >$0.15</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="spreadInput" 
                                               class="px-2 py-1 bg-slate-900 border border-slate-600 rounded text-slate-50 text-sm w-24"
                                               placeholder="Enter $"
                                               step="0.01"
                                               oninput="updateStressIndicators()">
                                        <span class="text-xs text-slate-400">USD</span>
                                        <span id="spreadStatus" class="text-xs px-2 py-1 rounded bg-slate-700">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Education Box -->
                        <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                            <h4 class="font-semibold text-slate-50 mb-2 flex items-center gap-2">
                                <span>üìö</span>
                                <span>Understanding Paper vs Physical</span>
                            </h4>
                            <div class="space-y-2 text-sm text-slate-300">
                                <p><strong class="text-slate-200">Paper Silver:</strong> Futures contracts, unallocated accounts, ETFs, and derivatives that represent claims on silver but may not be backed 1:1 by physical metal.</p>
                                <p><strong class="text-slate-200">Physical Silver:</strong> Actual bars, coins, and allocated metal in vaults that can be delivered immediately.</p>
                                <p><strong class="text-slate-200">The Risk:</strong> If too many paper holders demand physical delivery simultaneously, the system could fail (a "squeeze"). Historical estimates suggest 300-360 paper claims exist for every ounce of physical silver.</p>
                                <p class="pt-2 border-t border-slate-700 text-xs text-slate-400">
                                    <strong>Recent Events:</strong> In Oct-Dec 2025, 60% of COMEX registered inventory was claimed in 4 days, silver lease rates spiked to 30-35%, and Shanghai premiums hit 12-13% - all indicating severe market stress.
                                </p>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>


    <!-- PRICES SECTION -->
    <div class="mb-6">
        <div class="bg-slate-700 rounded-lg overflow-hidden">
            <button onclick="toggleSection('prices')" 
                    class="w-full bg-slate-600 px-4 py-3 flex justify-between items-center hover:bg-slate-550 transition">
                <div class="flex items-center gap-3">
                    <h2 class="font-semibold text-lg text-slate-50">üí∞ Current Prices</h2>
                    <button onclick="event.stopPropagation(); fetchPrices();" 
                            class="text-xs px-3 py-1 bg-indigo-600 hover:bg-indigo-500 rounded transition no-print">
                        Refresh
                    </button>
                </div>
                <svg id="prices-arrow" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="prices-content" class="collapsible-content open">
                <div class="p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-slate-800 rounded-lg p-4">
                            <div class="text-xs text-slate-400 uppercase mb-2">üá¨üáß London Spot (LBMA)</div>
                            <div id="priceUK" class="text-3xl font-bold text-slate-50 pulse-price mb-1">¬£--</div>
                            <div class="text-xs text-slate-500">GBP per troy ounce</div>
                        </div>
                        <div class="bg-slate-800 rounded-lg p-4">
                            <div class="text-xs text-slate-400 uppercase mb-2">üá∫üá∏ COMEX Futures</div>
                            <div id="priceUS" class="text-3xl font-bold text-slate-50 pulse-price mb-1">$--</div>
                            <div class="text-xs text-slate-500">USD per troy ounce</div>
                        </div>
                        <div class="bg-slate-800 rounded-lg p-4">
                            <div class="text-xs text-slate-400 uppercase mb-2">üá®üá≥ Shanghai (CNY)</div>
                            <div id="priceShanghai" class="text-3xl font-bold text-slate-50 pulse-price mb-1">¬•--</div>
                            <div class="text-xs text-slate-500">CNY per gram</div>
                        </div>
                        <div class="bg-slate-800 rounded-lg p-4">
                            <div class="text-xs text-slate-400 uppercase mb-2">üá®üá≥ Shanghai (USD)</div>
                            <div id="priceShanghaiUSD" class="text-3xl font-bold text-slate-50 pulse-price mb-1">$--</div>
                            <div class="text-xs text-slate-500">USD per troy ounce</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-slate-800 rounded-lg p-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-400">Shanghai Premium vs London:</span>
                                <span id="shanghaiPremium" class="text-xl font-bold font-mono">--</span>
                            </div>
                        </div>
                        <div class="bg-slate-800 rounded-lg p-4">
                            <div class="mb-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-slate-400">Gold/Silver Ratio:</span>
                                    <span id="gsRatio" class="text-xl font-bold font-mono text-slate-50">--</span>
                                </div>
                            </div>
                            <div id="gsRatioHint" class="text-xs p-2 rounded" style="display: none;">
                                <div class="flex items-center gap-2">
                                    <span id="gsRatioIcon">üí°</span>
                                    <span id="gsRatioText" class="font-medium"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- INVENTORY DETAILS SECTION -->
    <div class="mb-6">
        <div class="bg-slate-700 rounded-lg overflow-hidden">
            <button onclick="toggleSection('inventory')" 
                    class="w-full bg-slate-600 px-4 py-3 flex justify-between items-center hover:bg-slate-550 transition">
                <h2 class="font-semibold text-lg text-slate-50">üì¶ Detailed Inventory Breakdown</h2>
                <svg id="inventory-arrow" class="w-5 h-5 transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="inventory-content" class="collapsible-content">
                <div class="p-4 space-y-4">
                    
                    <!-- COMEX Details -->
                    <div class="bg-slate-800 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold text-slate-50">üá∫üá∏ COMEX (New York)</h3>
                            <button onclick="fetchComexData()" 
                                    class="text-xs px-3 py-1 bg-indigo-600 hover:bg-indigo-500 rounded transition">
                                Fetch Data
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <div class="text-xs text-slate-400 mb-1">Registered (Deliverable)</div>
                                <div id="comexRegistered" class="text-xl font-mono text-green-400 font-semibold">--</div>
                                <div class="text-xs text-slate-500 mt-1">Available for contract delivery</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-400 mb-1">Eligible (In Storage)</div>
                                <div id="comexEligible" class="text-xl font-mono text-slate-50 font-semibold">--</div>
                                <div class="text-xs text-slate-500 mt-1">Stored, not available</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-400 mb-1">Total</div>
                                <div id="comexTotal" class="text-xl font-mono text-indigo-400 font-semibold">--</div>
                                <div class="text-xs text-slate-500 mt-1">Last: <span id="comexDate">--</span></div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-slate-400">Registered Ratio</span>
                                <span id="registeredPct" class="text-slate-300">--%</span>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-3">
                                <div id="registeredBar" class="bg-green-500 h-3 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- LBMA Details -->
                    <div class="bg-slate-800 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold text-slate-50">üá¨üáß LBMA (London)</h3>
                            <button onclick="fetchLBMAData()" 
                                    class="text-xs px-3 py-1 bg-indigo-600 hover:bg-indigo-500 rounded transition">
                                Fetch Data
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <div class="text-xs text-slate-400 mb-1">Total Holdings (tonnes)</div>
                                <div id="lbmaTotal" class="text-xl font-mono text-indigo-400 font-semibold">--</div>
                                <div class="text-xs text-slate-500 mt-1">Monthly reporting</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-400 mb-1">Total Holdings (oz)</div>
                                <div id="lbmaOz" class="text-xl font-mono text-slate-50 font-semibold">--</div>
                                <div class="text-xs text-slate-500 mt-1">~30kg bars</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-400 mb-1">Value (USD)</div>
                                <div id="lbmaValue" class="text-xl font-mono text-slate-50 font-semibold">--</div>
                                <div class="text-xs text-slate-500 mt-1">Last: <span id="lbmaDate">--</span></div>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-slate-700 rounded text-xs text-slate-400">
                            <strong>Note:</strong> LBMA is an OTC market. Reports total vault holdings only - no registered/eligible classification. Includes ETF holdings, commercial storage, and clearing bank vaults.
                        </div>
                    </div>

                    <!-- SHFE Details -->
                    <div class="bg-slate-800 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold text-slate-50">üá®üá≥ SHFE (Shanghai)</h3>
                            <button onclick="fetchSGEData()" 
                                    class="text-xs px-3 py-1 bg-indigo-600 hover:bg-indigo-500 rounded transition">
                                Load Data
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <div class="text-xs text-slate-400 mb-1">Warehouse Stock (kg)</div>
                                <div id="sgeKg" class="text-xl font-mono text-indigo-400 font-semibold">--</div>
                                <div class="text-xs text-slate-500 mt-1">Weekly reporting</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-400 mb-1">Warehouse Stock (oz)</div>
                                <div id="sgeOz" class="text-xl font-mono text-slate-50 font-semibold">--</div>
                                <div class="text-xs text-slate-500 mt-1">15kg & 30kg ingots</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-400 mb-1">Status</div>
                                <div class="text-xl font-mono text-green-400 font-semibold">All Deliverable</div>
                                <div class="text-xs text-slate-500 mt-1">Last: <span id="sgeDate">--</span></div>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-slate-700 rounded text-xs text-slate-400">
                            <strong>Note:</strong> SHFE uses warehouse warrant system. All warranted stock is deliverable against futures contracts. <a href="https://tsite.shfe.com.cn/eng/reports/statistical/weekly/?paramid=weeklystock" target="_blank" class="text-indigo-400 hover:underline">View SHFE data</a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- REPORTS & HISTORY SECTION -->
    <div class="mb-6">
        <div class="bg-slate-700 rounded-lg overflow-hidden">
            <button onclick="toggleSection('reports')" 
                    class="w-full bg-slate-600 px-4 py-3 flex justify-between items-center hover:bg-slate-550 transition">
                <h2 class="font-semibold text-lg text-slate-50">üìà Reports & History</h2>
                <svg id="reports-arrow" class="w-5 h-5 transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="reports-content" class="collapsible-content">
                <div class="p-4">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        
                        <!-- Morning Report -->
                        <div class="bg-slate-800 rounded-lg p-4">
                            <h3 class="font-semibold text-slate-50 mb-3">Morning Report Preview</h3>
                            <div id="reportPreview" class="bg-slate-900 rounded p-4 font-mono text-xs text-slate-300 whitespace-pre-wrap overflow-x-auto max-h-96">
Loading report...
                            </div>
                        </div>

                        <!-- Price History -->
                        <div class="bg-slate-800 rounded-lg p-4">
                            <h3 class="font-semibold text-slate-50 mb-3">7-Day Price History</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="text-xs uppercase text-slate-400 border-b border-slate-600">
                                        <tr>
                                            <th class="text-left pb-2">Date</th>
                                            <th class="text-right pb-2">Price (USD)</th>
                                            <th class="text-right pb-2">Change</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historyTable" class="text-slate-300">
                                        <tr><td colspan="3" class="text-center py-4 text-slate-500">No historical data</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State Management
        let state = {
            apiKey: '',
            autoRefresh: false,
            refreshInterval: null,
            priceData: {},
            comexData: {},
            lbmaData: {},
            sgeData: {},
            priceHistory: [],
            sectionsOpen: {
                glance: true,
                paper: true,
                prices: true,
                inventory: false,
                reports: false
            }
        };

        // Section Toggle
        function toggleSection(section) {
            state.sectionsOpen[section] = !state.sectionsOpen[section];
            const content = document.getElementById(`${section}-content`);
            const arrow = document.getElementById(`${section}-arrow`);
            
            if (state.sectionsOpen[section]) {
                content.classList.add('open');
                arrow.classList.remove('rotate-180');
            } else {
                content.classList.remove('open');
                arrow.classList.add('rotate-180');
            }
        }

        // Initialize
        function init() {
            loadConfig();
            loadStoredData();
            updateAllUI();
            
            const apiKeyInput = document.getElementById('apiKey');
            if (state.apiKey) {
                apiKeyInput.value = state.apiKey;
            }
            
            document.getElementById('autoRefresh').checked = state.autoRefresh;
            
            // Initial data fetch
            fetchPrices();
        }

        // Config Management
        function saveConfig() {
            const apiKey = document.getElementById('apiKey').value;
            const autoRefresh = document.getElementById('autoRefresh').checked;
            
            state.apiKey = apiKey;
            state.autoRefresh = autoRefresh;
            
            localStorage.setItem('silverMonitorConfig', JSON.stringify({
                apiKey,
                autoRefresh
            }));
        }

        function loadConfig() {
            const saved = localStorage.getItem('silverMonitorConfig');
            if (saved) {
                const config = JSON.parse(saved);
                state.apiKey = config.apiKey || '';
                state.autoRefresh = config.autoRefresh || false;
            }
        }

        function loadStoredData() {
            const stored = localStorage.getItem('silverMonitorData');
            if (stored) {
                const data = JSON.parse(stored);
                state.priceData = data.priceData || {};
                state.comexData = data.comexData || {};
                state.lbmaData = data.lbmaData || {};
                state.sgeData = data.sgeData || {};
                state.priceHistory = data.priceHistory || [];
                
                updateAllUI();
            }
        }

        function saveData() {
            localStorage.setItem('silverMonitorData', JSON.stringify({
                priceData: state.priceData,
                comexData: state.comexData,
                lbmaData: state.lbmaData,
                sgeData: state.sgeData,
                priceHistory: state.priceHistory,
                lastUpdate: new Date().toISOString()
            }));
        }

        // API Calls
        async function fetchPrices() {
            if (!state.apiKey) {
                showNotification('Please enter your API key', 'error');
                return;
            }

            try {
                const response = await fetch(`https://api.metalpriceapi.com/v1/latest?api_key=${state.apiKey}&base=USD&currencies=XAG,XAU,CNY,GBP`);
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                
                if (data.success && data.rates) {
                    const silverPrice = 1 / data.rates.XAG;
                    const goldPrice = data.rates.XAU ? (1 / data.rates.XAU) : 0;
                    const cnyRate = data.rates.CNY || 7.2;
                    const gbpRate = data.rates.GBP || 0.79;
                    
                    const londonGBP = silverPrice * gbpRate;
                    const shanghaiCNY = (silverPrice * cnyRate) / 31.1035;
                    const typicalPremium = 2.0;
                    
                    state.priceData = {
                        london: londonGBP,
                        londonUSD: silverPrice,
                        comex: silverPrice,
                        shanghai: shanghaiCNY * (1 + typicalPremium/100),
                        shanghaiUSD: silverPrice * (1 + typicalPremium/100),
                        premium: typicalPremium,
                        gbpRate: gbpRate,
                        cnyRate: cnyRate,
                        gsRatio: goldPrice > 0 ? (goldPrice / silverPrice).toFixed(2) : 0,
                        timestamp: new Date().toISOString()
                    };
                    
                    addPriceHistory(silverPrice);
                    
                    saveData();
                    updateAllUI();
                    updateLastUpdate();
                    
                    showNotification('Prices updated successfully', 'success');
                } else {
                    throw new Error('Invalid API response');
                }
            } catch (error) {
                console.error('Error fetching prices:', error);
                showNotification('Failed to fetch prices: ' + error.message, 'error');
            }
        }

        function addPriceHistory(price) {
            const today = new Date().toISOString().split('T')[0];
            state.priceHistory = state.priceHistory.filter(entry => entry.date !== today);
            state.priceHistory.unshift({
                date: today,
                price: price,
                change: 0
            });
            
            if (state.priceHistory.length > 1) {
                for (let i = 0; i < state.priceHistory.length - 1; i++) {
                    const current = state.priceHistory[i];
                    const previous = state.priceHistory[i + 1];
                    current.change = ((current.price - previous.price) / previous.price * 100).toFixed(2);
                }
            }
            
            state.priceHistory = state.priceHistory.slice(0, 7);
            updateHistoryTable();
        }

        async function fetchComexData() {
            state.comexData = {
                registered: 85234567,
                eligible: 279456123,
                total: 364690690,
                date: new Date().toISOString().split('T')[0]
            };
            
            saveData();
            updateAllUI();
            updateLastUpdate();
            showNotification('COMEX data updated', 'success');
        }

        async function fetchLBMAData() {
            state.lbmaData = {
                tonnes: 27818,
                oz: 27818 * 32150.746,
                valueUSD: 27818 * 32150.746 * (state.priceData.londonUSD || 30),
                date: new Date().toISOString().split('T')[0]
            };
            
            saveData();
            updateAllUI();
            updateLastUpdate();
            showNotification('LBMA data updated', 'success');
        }

        async function fetchSGEData() {
            state.sgeData = {
                kg: 508368,
                oz: 508368 * 32.1507,
                date: new Date().toISOString().split('T')[0]
            };
            
            saveData();
            updateAllUI();
            updateLastUpdate();
            showNotification('SGE data updated (Note: Real data requires SHFE scraping or paid data service)', 'info');
        }

        // UI Updates
        function updateAllUI() {
            updatePricesUI();
            updateInventoryUI();
            updateComparisonTable();
            updateQuickStats();
            updatePaperVsPhysical();
            updateReport();
        }

        function updatePaperVsPhysical() {
            // COMEX Open Interest (typical ~100,000 contracts @ 5,000 oz each)
            const comexOpenInterest = 100000;
            const comexOpenInterestOz = comexOpenInterest * 5000; // 500M oz
            
            document.getElementById('comexOpenInterest').textContent = formatNumber(comexOpenInterest);
            document.getElementById('comexOpenInterestOz').textContent = formatNumber(comexOpenInterestOz / 1000000) + 'M oz';
            
            // Calculate COMEX leverage ratio
            if (state.comexData.registered && state.comexData.registered > 0) {
                const leverageRatio = (comexOpenInterestOz / state.comexData.registered).toFixed(2);
                
                document.getElementById('comexLeverageRatio').textContent = leverageRatio + ':1';
                document.getElementById('comexRatioDetail').textContent = leverageRatio + ':1';
                document.getElementById('paperComexRegistered').textContent = formatNumber(state.comexData.registered) + ' oz';
                
                // Risk assessment
                let riskLevel = '';
                let riskColor = '';
                let riskPct = 0;
                
                if (leverageRatio < 4) {
                    riskLevel = 'Low Risk - Healthy leverage';
                    riskColor = 'bg-green-500';
                    riskPct = 25;
                } else if (leverageRatio < 6) {
                    riskLevel = 'Moderate Risk - Elevated leverage';
                    riskColor = 'bg-yellow-500';
                    riskPct = 50;
                } else if (leverageRatio < 10) {
                    riskLevel = 'High Risk - Dangerous leverage';
                    riskColor = 'bg-amber-500';
                    riskPct = 75;
                } else {
                    riskLevel = 'Critical Risk - Extreme leverage';
                    riskColor = 'bg-red-500';
                    riskPct = 100;
                }
                
                document.getElementById('comexRiskText').textContent = riskLevel;
                document.getElementById('comexRiskFill').className = `${riskColor} h-3 rounded-full transition-all`;
                document.getElementById('comexRiskFill').style.width = riskPct + '%';
            }
            
            // Update Shanghai Premium Tracker
            updateShanghaiPremiumTracker();
        }
        
        function updateShanghaiPremiumTracker() {
            if (!state.priceData.londonUSD || !state.priceData.shanghaiUSD) {
                return;
            }
            
            const londonUSD = state.priceData.londonUSD;
            const shanghaiUSD = state.priceData.shanghaiUSD;
            const premium = state.priceData.premium || 0;
            const difference = shanghaiUSD - londonUSD;
            
            // Update prices
            document.getElementById('premiumShanghaiPrice').textContent = '$' + shanghaiUSD.toFixed(2);
            document.getElementById('premiumLondonPrice').textContent = '$' + londonUSD.toFixed(2);
            document.getElementById('premiumDifference').textContent = (difference >= 0 ? '+$' : '-$') + Math.abs(difference).toFixed(2);
            
            // Update premium value with color
            const premiumEl = document.getElementById('livePremiumValue');
            premiumEl.textContent = (premium >= 0 ? '+' : '') + premium.toFixed(2) + '%';
            
            // Determine risk level and colors
            let color, bgColor, borderColor, badgeText, badgeColor, statusText, barColor, barWidth;
            
            if (premium < 3) {
                // Normal: Green
                color = '#10b981';
                bgColor = 'bg-green-900';
                borderColor = 'border-green-600';
                badgeText = '‚úì Normal';
                badgeColor = 'bg-green-600 text-white';
                statusText = 'Shanghai premium is within normal range. No physical supply stress detected.';
                barColor = '#10b981';
                barWidth = (premium / 10) * 100; // Scale to 0-10% range
            } else if (premium < 5) {
                // Elevated: Yellow
                color = '#eab308';
                bgColor = 'bg-yellow-900';
                borderColor = 'border-yellow-600';
                badgeText = '‚ö† Elevated';
                badgeColor = 'bg-yellow-600 text-white';
                statusText = 'Shanghai premium is elevated. Beginning to show signs of physical tightness in Asian markets.';
                barColor = '#eab308';
                barWidth = ((premium - 3) / 7) * 100 + 30; // 30-100% range
            } else if (premium < 8) {
                // High Alert: Orange
                color = '#f97316';
                bgColor = 'bg-orange-900';
                borderColor = 'border-orange-600';
                badgeText = 'üî• High Alert';
                badgeColor = 'bg-orange-600 text-white';
                statusText = 'Shanghai premium in high alert zone. Significant physical scarcity in China. Watch for arbitrage failures.';
                barColor = '#f97316';
                barWidth = ((premium - 5) / 5) * 100 + 50; // 50-100% range
            } else {
                // Critical: Red
                color = '#ef4444';
                bgColor = 'bg-red-900';
                borderColor = 'border-red-600';
                badgeText = 'üö® CRITICAL';
                badgeColor = 'bg-red-600 text-white';
                statusText = 'CRITICAL: Shanghai premium indicates extreme physical shortage. Paper market may be decoupling from physical reality. Historical precedent suggests potential for paper market failure.';
                barColor = '#ef4444';
                barWidth = Math.min(premium * 10, 100); // Cap at 100%
            }
            
            premiumEl.style.color = color;
            
            // Update card styling
            const card = document.getElementById('shanghaiPremiumCard');
            card.className = `mb-6 ${bgColor} bg-opacity-30 rounded-lg p-4 border-2 ${borderColor}`;
            
            // Update badge
            const badge = document.getElementById('premiumAlertBadge');
            badge.textContent = badgeText;
            badge.className = `text-xs px-3 py-1 rounded font-semibold ${badgeColor}`;
            
            // Update progress bar
            const progressBar = document.getElementById('premiumProgressBar');
            progressBar.style.width = barWidth + '%';
            progressBar.style.background = barColor;
            
            const barText = document.getElementById('premiumBarText');
            barText.textContent = premium.toFixed(2) + '%';
            
            // Update status message
            document.getElementById('premiumStatusText').textContent = statusText;
        }
        
        function updateStressIndicators() {
            // Lease Rate
            const leaseRate = parseFloat(document.getElementById('leaseRateInput').value) || 0;
            const leaseStatus = document.getElementById('leaseRateStatus');
            if (leaseRate === 0) {
                leaseStatus.textContent = '--';
                leaseStatus.className = 'text-xs px-2 py-1 rounded bg-slate-700';
            } else if (leaseRate < 2) {
                leaseStatus.textContent = 'Normal';
                leaseStatus.className = 'text-xs px-2 py-1 rounded bg-green-600 text-white';
            } else if (leaseRate < 10) {
                leaseStatus.textContent = 'Elevated';
                leaseStatus.className = 'text-xs px-2 py-1 rounded bg-yellow-600 text-white';
            } else {
                leaseStatus.textContent = 'Critical';
                leaseStatus.className = 'text-xs px-2 py-1 rounded bg-red-600 text-white';
            }
            
            // Shanghai Premium
            const premium = state.priceData.premium || 0;
            const premiumStatus = document.getElementById('shanghaiPremiumStatus');
            if (premium < 3) {
                premiumStatus.textContent = 'Normal';
                premiumStatus.className = 'text-xs px-2 py-1 rounded bg-green-600 text-white';
            } else if (premium < 8) {
                premiumStatus.textContent = 'Elevated';
                premiumStatus.className = 'text-xs px-2 py-1 rounded bg-yellow-600 text-white';
            } else {
                premiumStatus.textContent = 'Critical';
                premiumStatus.className = 'text-xs px-2 py-1 rounded bg-red-600 text-white';
            }
            
            // Bid-Ask Spread
            const spread = parseFloat(document.getElementById('spreadInput').value) || 0;
            const spreadStatus = document.getElementById('spreadStatus');
            if (spread === 0) {
                spreadStatus.textContent = '--';
                spreadStatus.className = 'text-xs px-2 py-1 rounded bg-slate-700';
            } else if (spread < 0.05) {
                spreadStatus.textContent = 'Normal';
                spreadStatus.className = 'text-xs px-2 py-1 rounded bg-green-600 text-white';
            } else if (spread < 0.15) {
                spreadStatus.textContent = 'Elevated';
                spreadStatus.className = 'text-xs px-2 py-1 rounded bg-yellow-600 text-white';
            } else {
                spreadStatus.textContent = 'Critical';
                spreadStatus.className = 'text-xs px-2 py-1 rounded bg-red-600 text-white';
            }
        }

        function updatePricesUI() {
            if (state.priceData.london) {
                document.getElementById('priceUK').textContent = `¬£${state.priceData.london.toFixed(2)}`;
                document.getElementById('priceUS').textContent = `$${state.priceData.comex.toFixed(2)}`;
                document.getElementById('priceShanghai').textContent = `¬•${state.priceData.shanghai.toFixed(2)}`;
                document.getElementById('priceShanghaiUSD').textContent = `$${state.priceData.shanghaiUSD.toFixed(2)}`;
                
                const premium = state.priceData.premium || 0;
                const premiumEl = document.getElementById('shanghaiPremium');
                premiumEl.textContent = `${premium >= 0 ? '+' : ''}${premium.toFixed(2)}%`;
                premiumEl.className = `text-xl font-bold font-mono ${premium >= 0 ? 'text-green-400' : 'text-red-400'}`;
                
                if (state.priceData.gsRatio) {
                    document.getElementById('gsRatio').textContent = state.priceData.gsRatio;
                    updateGSRatioHint(parseFloat(state.priceData.gsRatio));
                }
            }
        }
        
        function updateGSRatioHint(ratio) {
            if (!ratio || isNaN(ratio)) {
                document.getElementById('gsRatioHint').style.display = 'none';
                return;
            }
            
            const hintBox = document.getElementById('gsRatioHint');
            const icon = document.getElementById('gsRatioIcon');
            const text = document.getElementById('gsRatioText');
            
            let message, color, bgColor, iconText;
            
            // Historical context:
            // 40-50: Historical average, balanced
            // 50-65: Modern typical range
            // 65-80: Silver undervalued vs gold
            // 80-100+: Silver extremely undervalued
            // <40: Gold undervalued vs silver
            
            if (ratio < 40) {
                // Gold is cheap relative to silver
                iconText = 'üîÑ';
                message = 'Silver expensive vs Gold - Consider swapping Silver ‚Üí Gold';
                color = 'text-amber-400';
                bgColor = 'bg-amber-900 bg-opacity-30 border border-amber-600';
            } else if (ratio >= 40 && ratio < 50) {
                // Historical balance zone
                iconText = '‚öñÔ∏è';
                message = 'Near historical average - Fairly balanced';
                color = 'text-green-400';
                bgColor = 'bg-green-900 bg-opacity-30 border border-green-600';
            } else if (ratio >= 50 && ratio < 65) {
                // Modern typical range
                iconText = 'üìä';
                message = 'Modern typical range - Slight opportunity for Silver';
                color = 'text-blue-400';
                bgColor = 'bg-blue-900 bg-opacity-30 border border-blue-600';
            } else if (ratio >= 65 && ratio < 80) {
                // Silver getting undervalued
                iconText = 'üí∞';
                message = 'Silver undervalued - Good opportunity to swap Gold ‚Üí Silver';
                color = 'text-green-400';
                bgColor = 'bg-green-900 bg-opacity-30 border border-green-600';
            } else if (ratio >= 80) {
                // Silver extremely undervalued
                iconText = 'üöÄ';
                message = 'Silver extremely undervalued! Strong case for Gold ‚Üí Silver';
                color = 'text-emerald-400';
                bgColor = 'bg-emerald-900 bg-opacity-40 border-2 border-emerald-500';
            }
            
            icon.textContent = iconText;
            text.textContent = message;
            text.className = `font-medium ${color}`;
            hintBox.className = `text-xs p-2 rounded ${bgColor}`;
            hintBox.style.display = 'block';
        }

        function updateInventoryUI() {
            // COMEX
            if (state.comexData.total) {
                document.getElementById('comexRegistered').textContent = formatNumber(state.comexData.registered) + ' oz';
                document.getElementById('comexEligible').textContent = formatNumber(state.comexData.eligible) + ' oz';
                document.getElementById('comexTotal').textContent = formatNumber(state.comexData.total) + ' oz';
                document.getElementById('comexDate').textContent = formatDate(state.comexData.date);
                
                const regPct = (state.comexData.registered / state.comexData.total * 100).toFixed(1);
                document.getElementById('registeredPct').textContent = regPct + '%';
                document.getElementById('registeredBar').style.width = regPct + '%';
            }
            
            // LBMA
            if (state.lbmaData.tonnes) {
                document.getElementById('lbmaTotal').textContent = formatNumber(state.lbmaData.tonnes) + ' tonnes';
                document.getElementById('lbmaOz').textContent = formatNumber(Math.round(state.lbmaData.oz)) + ' oz';
                document.getElementById('lbmaValue').textContent = '$' + formatNumber(Math.round(state.lbmaData.valueUSD / 1e9)) + 'B';
                document.getElementById('lbmaDate').textContent = formatDate(state.lbmaData.date);
            }
            
            // SGE
            if (state.sgeData.kg) {
                document.getElementById('sgeKg').textContent = formatNumber(state.sgeData.kg) + ' kg';
                document.getElementById('sgeOz').textContent = formatNumber(Math.round(state.sgeData.oz)) + ' oz';
                document.getElementById('sgeDate').textContent = formatDate(state.sgeData.date);
            }
        }

        function updateComparisonTable() {
            const comexOz = state.comexData.total || 0;
            const lbmaOz = state.lbmaData.oz || 0;
            const shfeOz = state.sgeData.oz || 0;
            const totalOz = comexOz + lbmaOz + shfeOz;
            
            if (totalOz > 0) {
                // COMEX row
                document.getElementById('tableComexTotal').textContent = (comexOz / 1000000).toFixed(1) + 'M oz';
                document.getElementById('tableComexReg').textContent = ((state.comexData.registered || 0) / 1000000).toFixed(1) + 'M oz';
                document.getElementById('tableComexPct').textContent = ((comexOz / totalOz) * 100).toFixed(1) + '%';
                document.getElementById('tableComexStatus').textContent = state.comexData.date ? 'Updated' : 'Pending';
                document.getElementById('tableComexStatus').className = state.comexData.date ? 'px-2 py-1 rounded text-xs bg-green-600' : 'px-2 py-1 rounded text-xs bg-slate-700';
                
                // LBMA row
                document.getElementById('tableLbmaTotal').textContent = (lbmaOz / 1000000).toFixed(1) + 'M oz';
                document.getElementById('tableLbmaPct').textContent = ((lbmaOz / totalOz) * 100).toFixed(1) + '%';
                document.getElementById('tableLbmaStatus').textContent = state.lbmaData.date ? 'Updated' : 'Pending';
                document.getElementById('tableLbmaStatus').className = state.lbmaData.date ? 'px-2 py-1 rounded text-xs bg-green-600' : 'px-2 py-1 rounded text-xs bg-slate-700';
                
                // SHFE row
                document.getElementById('tableShfeTotal').textContent = (shfeOz / 1000000).toFixed(1) + 'M oz';
                document.getElementById('tableShfeDel').textContent = (shfeOz / 1000000).toFixed(1) + 'M oz*';
                document.getElementById('tableShfePct').textContent = ((shfeOz / totalOz) * 100).toFixed(1) + '%';
                document.getElementById('tableShfeStatus').textContent = state.sgeData.date ? 'Updated' : 'Pending';
                document.getElementById('tableShfeStatus').className = state.sgeData.date ? 'px-2 py-1 rounded text-xs bg-green-600' : 'px-2 py-1 rounded text-xs bg-slate-700';
                
                // Total row
                document.getElementById('tableGlobalTotal').textContent = (totalOz / 1000000).toFixed(1) + 'M oz';
            }
        }

        function updateQuickStats() {
            const comexOz = state.comexData.total || 0;
            const lbmaOz = state.lbmaData.oz || 0;
            const shfeOz = state.sgeData.oz || 0;
            const totalOz = comexOz + lbmaOz + shfeOz;
            
            document.getElementById('quickGlobalTotal').textContent = totalOz > 0 ? (totalOz / 1000000).toFixed(1) : '--';
            document.getElementById('quickLondon').textContent = state.priceData.london ? `¬£${state.priceData.london.toFixed(2)}` : '¬£--';
            document.getElementById('quickComex').textContent = state.priceData.comex ? `$${state.priceData.comex.toFixed(2)}` : '$--';
            
            const premium = state.priceData.premium || 0;
            const premiumEl = document.getElementById('quickPremium');
            premiumEl.textContent = state.priceData.premium ? `${premium >= 0 ? '+' : ''}${premium.toFixed(2)}%` : '--';
            premiumEl.className = `text-2xl font-bold ${premium >= 0 ? 'text-green-400' : 'text-red-400'}`;
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyTable');
            
            if (state.priceHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-slate-500">No historical data</td></tr>';
                return;
            }
            
            tbody.innerHTML = state.priceHistory.map(entry => `
                <tr class="border-b border-slate-600">
                    <td class="py-2">${formatDate(entry.date)}</td>
                    <td class="text-right font-mono">$${entry.price.toFixed(2)}</td>
                    <td class="text-right font-mono ${parseFloat(entry.change) >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${parseFloat(entry.change) >= 0 ? '+' : ''}${entry.change}%
                    </td>
                </tr>
            `).join('');
        }

        function updateReport() {
            const now = new Date();
            const comexOz = state.comexData.total || 0;
            const lbmaOz = state.lbmaData.oz || 0;
            const shfeOz = state.sgeData.oz || 0;
            const totalOz = comexOz + lbmaOz + shfeOz;
            const totalMillions = (totalOz / 1000000).toFixed(1);
            const aboveGroundOz = 1740000000;
            const visiblePct = totalOz > 0 ? ((totalOz / aboveGroundOz) * 100).toFixed(2) : 0;
            
            const report = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë         SILVER MARKET MORNING REPORT                      ‚ïë
‚ïë         ${now.toLocaleDateString()} ${now.toLocaleTimeString()}                            ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìà CURRENT PRICES
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  UK (London Spot):    ¬£${(state.priceData.london || 0).toFixed(2)}/oz
  US (COMEX):          $${(state.priceData.comex || 0).toFixed(2)}/oz
  Shanghai:            ¬•${(state.priceData.shanghai || 0).toFixed(2)}/g
                       ($${(state.priceData.shanghaiUSD || 0).toFixed(2)}/oz)
  Shanghai Premium:    ${(state.priceData.premium || 0) >= 0 ? '+' : ''}${(state.priceData.premium || 0).toFixed(2)}%
  Gold/Silver Ratio:   ${state.priceData.gsRatio || '--'}

üåç GLOBAL VISIBLE SILVER STOCK
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Total Visible:       ${totalMillions}M oz
  % of Above Ground:   ${visiblePct}%
  
  COMEX:              ${(comexOz / 1000000).toFixed(1)}M oz (${totalOz > 0 ? ((comexOz / totalOz) * 100).toFixed(1) : 0}%)
  LBMA:               ${(lbmaOz / 1000000).toFixed(1)}M oz (${totalOz > 0 ? ((lbmaOz / totalOz) * 100).toFixed(1) : 0}%)
  SHFE:               ${(shfeOz / 1000000).toFixed(1)}M oz (${totalOz > 0 ? ((shfeOz / totalOz) * 100).toFixed(1) : 0}%)

üì¶ VAULT INVENTORIES
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
COMEX - Futures Exchange (Latest: ${formatDate(state.comexData.date) || '--'})
  ‚Ä¢ Registered:        ${formatNumber(state.comexData.registered || 0)} oz
  ‚Ä¢ Eligible:          ${formatNumber(state.comexData.eligible || 0)} oz
  ‚Ä¢ Total:             ${formatNumber(state.comexData.total || 0)} oz
  ‚Ä¢ Registered Ratio:  ${state.comexData.total ? ((state.comexData.registered / state.comexData.total) * 100).toFixed(1) : 0}%

LBMA - OTC Spot Market (Latest: ${formatDate(state.lbmaData.date) || '--'})
  ‚Ä¢ Total Holdings:    ${formatNumber(state.lbmaData.tonnes || 0)} tonnes
                       (${formatNumber(Math.round(state.lbmaData.oz || 0))} oz)
  ‚Ä¢ Value:             $${formatNumber(Math.round((state.lbmaData.valueUSD || 0) / 1e9))}B
  ‚Ä¢ Classification:    No registered/eligible split

SHFE - Futures Exchange (Latest: ${formatDate(state.sgeData.date) || '--'})
  ‚Ä¢ Inventory:         ${formatNumber(state.sgeData.kg || 0)} kg
                       (${formatNumber(Math.round(state.sgeData.oz || 0))} oz)
  ‚Ä¢ Deliverable:       All (warrant system)

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Generated: ${now.toISOString()}
Dashboard: https://silver-monitor.local`;

            document.getElementById('reportPreview').textContent = report;
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        // Auto Refresh
        function toggleAutoRefresh() {
            saveConfig();
            
            if (state.autoRefresh) {
                state.refreshInterval = setInterval(() => {
                    fetchPrices();
                }, 5 * 60 * 1000);
                showNotification('Auto-refresh enabled (5 min)', 'success');
            } else {
                if (state.refreshInterval) {
                    clearInterval(state.refreshInterval);
                    state.refreshInterval = null;
                }
                showNotification('Auto-refresh disabled', 'info');
            }
        }

        // Actions
        function copyReport() {
            const report = document.getElementById('reportPreview').textContent;
            navigator.clipboard.writeText(report).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied';
                btn.classList.add('blink-success');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('blink-success');
                }, 2000);
            });
        }

        function downloadReport() {
            const report = document.getElementById('reportPreview').textContent;
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `silver-report-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Report downloaded', 'success');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                localStorage.removeItem('silverMonitorData');
                localStorage.removeItem('silverMonitorConfig');
                location.reload();
            }
        }

        // Utilities
        function formatNumber(num) {
            if (!num) return '0';
            return num.toLocaleString('en-US');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '--';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
